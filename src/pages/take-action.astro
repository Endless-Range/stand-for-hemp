---
/**
 * Stand for Hemp - Take Action Page
 *
 * Displays user's representatives and provides email/call action buttons.
 * Mobile-first, frictionless design following brand guidelines.
 */

import LandingLayout from '../layouts/LandingLayout.astro';
---

<LandingLayout
  title="Take Action - Contact Your Representatives | Stand for Hemp"
  description="Find your representatives and take action to save the hemp industry. Send emails or make calls in 60 seconds."
  ogImage="/og-image.jpg"
>
  <!-- Hero Section -->
  <section class="py-12 md:py-16" style="background-color: var(--color-soft-cream);">
    <div class="container mx-auto px-6 max-w-4xl text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4" style="color: var(--color-soil-dark);">
        Contact Your Representatives
      </h1>
      <p class="text-xl text-neutral-600 mb-8">
        Enter your zip code to find your representatives and take action
      </p>

      <!-- Zip Code Form -->
      <div class="max-w-form mx-auto">
        <form id="zip-form" class="flex flex-col sm:flex-row gap-4">
          <input
            type="text"
            id="zip-input"
            name="zip"
            inputmode="numeric"
            pattern="[0-9]{5}"
            maxlength="5"
            placeholder="Enter your zip code"
            required
            class="flex-1 px-6 py-4 text-lg rounded-lg border-2 border-neutral-300 bg-white text-[var(--color-soil-dark)] placeholder-neutral-500 focus:outline-none focus:border-[var(--color-hemp-green)] focus:ring-2 focus:ring-[var(--color-hemp-green)]/50"
            aria-label="Enter your 5-digit zip code"
          />
          <button
            type="submit"
            class="btn-primary whitespace-nowrap min-w-[180px]"
          >
            Find My Reps â†’
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <section id="loading-state" class="py-16 text-center hidden">
    <div class="container mx-auto px-6">
      <div class="text-[var(--color-hemp-green)] text-lg font-semibold">
        Finding your representatives...
      </div>
    </div>
  </section>

  <!-- Error State -->
  <section id="error-state" class="py-16 text-center hidden">
    <div class="container mx-auto px-6 max-w-2xl">
      <div class="card" style="border-left: 4px solid #dc2626;">
        <h2 class="text-2xl font-bold mb-4" style="color: #dc2626;">
          Oops! Something went wrong
        </h2>
        <p id="error-message" class="text-lg text-neutral-700 mb-4"></p>
        <button
          onclick="window.location.reload()"
          class="btn-primary"
        >
          Try Again
        </button>
      </div>
    </div>
  </section>

  <!-- Representatives List -->
  <section id="reps-section" class="py-16 bg-white hidden">
    <div class="container mx-auto px-6 max-w-5xl">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--color-soil-dark);">
          Your Representatives
        </h2>
        <p class="text-lg text-neutral-600">
          Contact them to save the hemp industry
        </p>
      </div>

      <!-- Representatives will be inserted here -->
      <div id="reps-container" class="space-y-8"></div>
    </div>
  </section>

  <!-- Representative Card Template -->
  <template id="rep-card-template">
    <div class="card rep-card">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Photo -->
        <div class="flex-shrink-0">
          <img
            class="rep-photo w-32 h-32 rounded-full object-cover mx-auto md:mx-0"
            alt=""
          />
        </div>

        <!-- Info -->
        <div class="flex-1">
          <div class="mb-4">
            <h3 class="text-2xl md:text-3xl font-bold mb-2 rep-name" style="color: var(--color-soil-dark);"></h3>
            <div class="flex flex-wrap gap-3 items-center text-neutral-600">
              <span class="rep-role font-semibold"></span>
              <span class="text-neutral-400">â€¢</span>
              <span class="rep-party"></span>
            </div>
          </div>

          <!-- Contact Info -->
          <div class="mb-6 space-y-2">
            <div class="rep-phone flex items-center gap-2 text-neutral-700">
              <span class="text-xl">ðŸ“ž</span>
              <a href="" class="phone-link hover:text-[var(--color-hemp-green)] transition-colors"></a>
            </div>
            <div class="rep-office text-neutral-600"></div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4">
            <button class="btn-email btn-primary flex-1">
              Contact Form
            </button>
            <button class="btn-call flex-1 px-6 py-3 rounded-lg font-semibold transition-all hover:transform hover:-translate-y-0.5 hover:shadow-lg border-2" style="border-color: var(--color-hemp-green); color: var(--color-hemp-green); background-color: transparent;">
              Call Now
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Scripts -->
  <script is:inline define:vars={{ apiKey: import.meta.env.PUBLIC_GOOGLE_CIVIC_API_KEY }}>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const zipFromUrl = urlParams.get('zip');

    // Elements
    const zipForm = document.getElementById('zip-form');
    const zipInput = document.getElementById('zip-input');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    const repsSection = document.getElementById('reps-section');
    const repsContainer = document.getElementById('reps-container');
    const repCardTemplate = document.getElementById('rep-card-template');

    // Debug logging
    console.log('Zip from URL:', zipFromUrl);

    // If zip code in URL, auto-fetch representatives
    if (zipFromUrl && zipFromUrl.match(/^\d{5}$/)) {
      zipInput.value = zipFromUrl;
      fetchRepresentatives(zipFromUrl);
    }

    // Form submit handler
    zipForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const zip = zipInput.value.trim();
      if (zip && zip.match(/^\d{5}$/)) {
        fetchRepresentatives(zip);
        // Update URL without reload
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('zip', zip);
        window.history.pushState({}, '', newUrl);
      }
    });

    /**
     * Fetch representatives directly from Google Civic API (client-side)
     */
    async function fetchRepresentatives(zip) {
      // Show loading state
      loadingState?.classList.remove('hidden');
      errorState?.classList.add('hidden');
      repsSection?.classList.add('hidden');

      try {
        // Call our server-side API endpoint (using dynamic route params instead of query strings)
        const apiUrl = `/api/representatives-v2/${encodeURIComponent(zip)}`;

        console.log('Fetching from:', apiUrl);

        const response = await fetch(apiUrl);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API returned ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('API response:', data);

        // Get representatives from response
        const representatives = data.representatives;

        if (!representatives || representatives.length === 0) {
          throw new Error('No representatives found for this zip code. Please try a different zip code.');
        }

        // Display representatives
        displayRepresentatives(representatives);

        // Hide loading, show results
        loadingState?.classList.add('hidden');
        repsSection?.classList.remove('hidden');

        // Scroll to results
        repsSection?.scrollIntoView({ behavior: 'smooth' });

      } catch (error) {
        console.error('Error fetching representatives:', error);

        // Show error state
        loadingState?.classList.add('hidden');
        errorState?.classList.remove('hidden');

        if (errorMessage) {
          errorMessage.textContent = error instanceof Error
            ? error.message
            : 'Could not load representatives. Please try again.';
        }
      }
    }

    /**
     * Display representatives in cards
     */
    function displayRepresentatives(representatives) {
      if (!repsContainer || !repCardTemplate) return;

      // Clear container
      repsContainer.innerHTML = '';

      // Create cards for each representative
      for (const rep of representatives) {
        console.log('Creating card for representative:', {
          name: rep.name,
          phone: rep.phone,
          contactForm: rep.contactForm,
          role: rep.role
        });

        const card = repCardTemplate.content.cloneNode(true);

        // Photo
        const photo = card.querySelector('.rep-photo');
        if (photo) {
          if (rep.photoUrl) {
            photo.src = rep.photoUrl;
            photo.alt = `Photo of ${rep.name}`;
          } else {
            // Default placeholder
            photo.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(rep.name)}&size=256&background=4a6741&color=fff&bold=true`;
            photo.alt = `${rep.name}`;
          }
        }

        // Name, role, party
        const nameEl = card.querySelector('.rep-name');
        const roleEl = card.querySelector('.rep-role');
        const partyEl = card.querySelector('.rep-party');

        if (nameEl) nameEl.textContent = rep.name;
        if (roleEl) roleEl.textContent = rep.role;
        if (partyEl) partyEl.textContent = rep.party;

        // Phone
        const phoneDiv = card.querySelector('.rep-phone');
        const phoneLink = card.querySelector('.phone-link');

        if (rep.phone && phoneDiv && phoneLink) {
          phoneLink.href = `tel:${rep.phone}`;
          phoneLink.textContent = rep.phone;
        } else if (phoneDiv) {
          phoneDiv.style.display = 'none';
        }

        // Office
        const officeEl = card.querySelector('.rep-office');
        if (officeEl) {
          officeEl.textContent = rep.office;
        }

        // Email button
        const emailBtn = card.querySelector('.btn-email');
        if (emailBtn) {
          emailBtn.addEventListener('click', () => {
            handleEmailAction(rep);
          });
        }

        // Call button
        const callBtn = card.querySelector('.btn-call');
        if (callBtn) {
          if (rep.phone) {
            callBtn.addEventListener('click', () => {
              console.log('Calling:', rep.name, 'at', rep.phone);
              window.location.href = `tel:${rep.phone}`;
            });
          } else {
            callBtn.disabled = true;
            callBtn.style.opacity = '0.5';
            callBtn.style.cursor = 'not-allowed';
            console.log('No phone number for:', rep.name);
          }
        }

        repsContainer.appendChild(card);
      }
    }

    /**
     * Handle email/contact form action
     * Opens the representative's contact form in a new tab
     */
    function handleEmailAction(rep) {
      console.log('Opening contact form for:', rep.name);
      console.log('Contact form URL:', rep.contactForm);

      if (rep.contactForm) {
        // Ensure URL has protocol
        let url = rep.contactForm;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        console.log('Opening URL:', url);
        window.open(url, '_blank');
      } else {
        // Fallback: show message if no contact form available
        alert(`Contact form not available for ${rep.name}. Please try calling instead: ${rep.phone || 'No phone number available'}`);
      }
    }
  </script>
</LandingLayout>
