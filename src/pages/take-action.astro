---
/**
 * Stand for Hemp - Take Action Page
 *
 * Displays user's representatives and provides email/call action buttons.
 * Mobile-first, frictionless design following brand guidelines.
 */

import LandingLayout from '../layouts/LandingLayout.astro';
import Navigation from '../components/Navigation.astro';
import InlineConfirmation from '../components/InlineConfirmation.astro';
---

<LandingLayout
  title="Take Action - Contact Your Representatives | Stand for Hemp"
  description="Find your representatives and take action to save the hemp industry. Send emails or make calls in 60 seconds."
  ogImage="/og-image.jpg"
>
  <Navigation />

  <!-- Hero Section -->
  <section id="hero-section" class="py-12 md:py-16" style="background-color: var(--color-soft-cream);">
    <div class="container mx-auto px-6 max-w-4xl text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-6" style="color: var(--color-soil-dark);">
        Take Action Now
      </h1>
      <p class="text-xl text-neutral-600 mb-6 max-w-content mx-auto">
        Your voice matters. Contact your representatives to save the hemp industry.
      </p>

      <!-- Quick Steps -->
      <div class="flex justify-center items-center gap-3 md:gap-6 mb-12 text-sm md:text-base text-neutral-600">
        <div class="flex items-center gap-2">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: var(--color-hemp-green);">1</span>
          <span>Grab your message</span>
        </div>
        <span class="text-neutral-400">‚Üí</span>
        <div class="flex items-center gap-2">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: var(--color-hemp-green);">2</span>
          <span>Contact your reps</span>
        </div>
        <span class="text-neutral-400">‚Üí</span>
        <div class="flex items-center gap-2">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: var(--color-hemp-green);">3</span>
          <span>Repeat weekly</span>
        </div>
      </div>

      <!-- Zip Code Form -->
      <div id="zip-form-container" class="max-w-form mx-auto mb-12">
        <form id="zip-form" class="flex flex-col sm:flex-row gap-4">
          <input
            type="text"
            id="zip-input"
            name="zip"
            inputmode="numeric"
            pattern="[0-9]{5}"
            maxlength="5"
            placeholder="Enter your zip code"
            required
            class="flex-1 px-6 py-4 text-lg rounded-lg border-2 border-neutral-300 bg-white text-[var(--color-soil-dark)] placeholder-neutral-500 focus:outline-none focus:border-[var(--color-hemp-green)] focus:ring-2 focus:ring-[var(--color-hemp-green)]/50"
            aria-label="Enter your 5-digit zip code"
          />
          <button
            type="submit"
            class="btn-primary whitespace-nowrap min-w-[180px]"
          >
            Find My Reps ‚Üí
          </button>
        </form>
      </div>

      <!-- How to Take Action -->
      <div id="how-to-section" class="text-left">
        <div class="card bg-white" style="border: 2px solid var(--color-hemp-green);">
          <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center" style="color: var(--color-hemp-green);">
            How to Take Action
          </h2>

          <div class="space-y-6">
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white" style="background-color: var(--color-hemp-green);">
                1
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2" style="color: var(--color-soil-dark);">Enter Your Zip Code</h3>
                <p class="text-neutral-600">We'll find your senators and representative instantly.</p>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white" style="background-color: var(--color-hemp-green);">
                2
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2" style="color: var(--color-soil-dark);">Copy Your Personalized Message</h3>
                <p class="text-neutral-600">Choose your role (consumer, farmer, or industry worker) and we'll generate a compelling message with your state's impact data.</p>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white" style="background-color: var(--color-hemp-green);">
                3
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2" style="color: var(--color-soil-dark);">Contact Your Reps</h3>
                <p class="text-neutral-600">Use the contact form or call their offices. Paste your message and send.</p>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white" style="background-color: var(--color-hemp-green);">
                ‚ü≥
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2" style="color: var(--color-hemp-green);">Do It Regularly</h3>
                <p class="text-neutral-600"><strong>Contact them at least once a week.</strong> Regular pressure from constituents is what drives change. Each call and email adds to the count and shows growing concern.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <section id="loading-state" class="py-16 text-center hidden">
    <div class="container mx-auto px-6">
      <div class="text-[var(--color-hemp-green)] text-lg font-semibold">
        Finding your representatives...
      </div>
    </div>
  </section>

  <!-- Error State -->
  <section id="error-state" class="py-16 text-center hidden">
    <div class="container mx-auto px-6 max-w-2xl">
      <div class="card" style="border-left: 4px solid #dc2626;">
        <h2 class="text-2xl font-bold mb-4" style="color: #dc2626;">
          Oops! Something went wrong
        </h2>
        <p id="error-message" class="text-lg text-neutral-700 mb-4"></p>
        <button
          onclick="window.location.reload()"
          class="btn-primary"
        >
          Try Again
        </button>
      </div>
    </div>
  </section>

  <!-- Message Template Section -->
  <section id="message-template-section" class="py-16 bg-white hidden">
    <div class="container mx-auto px-6 max-w-4xl">
      <div class="text-center mb-8">
        <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--color-soil-dark);">
          Your Personalized Message
        </h2>
        <p class="text-lg text-neutral-600 mb-6">
          Choose your role and we'll generate a message you can copy and paste
        </p>
      </div>

      <!-- Role Selector -->
      <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button
          class="role-btn"
          data-role="consumer"
          style="padding: 1rem 2rem; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: 2px solid var(--color-hemp-green); background-color: white; color: var(--color-hemp-green);"
        >
          I'm a Consumer
        </button>
        <button
          class="role-btn"
          data-role="farmer"
          style="padding: 1rem 2rem; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: 2px solid var(--color-hemp-green); background-color: white; color: var(--color-hemp-green);"
        >
          I'm a Farmer
        </button>
        <button
          class="role-btn"
          data-role="industry"
          style="padding: 1rem 2rem; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: 2px solid var(--color-hemp-green); background-color: white; color: var(--color-hemp-green);"
        >
          I Work in Hemp Industry
        </button>
      </div>

      <!-- Message Display (hidden until role selected) -->
      <div id="message-card" class="card hidden" style="background: white; border: 2px solid var(--color-hemp-green);">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold" style="color: var(--color-soil-dark);">Your Message:</h3>
          <button
            id="copy-message-btn"
            class="px-4 py-2 rounded-lg font-semibold transition-all"
            style="background-color: var(--color-hemp-green); color: white; border: none;"
          >
            üìã Copy Message
          </button>
        </div>
        <div
          id="message-content"
          class="p-4 rounded-lg text-left whitespace-pre-line"
          style="background-color: #f9fafb; border: 1px solid #e5e7eb; font-family: inherit; line-height: 1.6;"
        ></div>
        <div id="copy-success" class="hidden mt-4 text-center font-semibold" style="color: var(--color-hemp-green);">
          ‚úì Message copied to clipboard!
        </div>
      </div>
    </div>
  </section>

  <!-- Representatives List -->
  <section id="reps-section" class="py-16 hidden" style="background-color: var(--color-soft-cream);">
    <div class="container mx-auto px-6 max-w-7xl">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--color-soil-dark);">
          Contact Your Representatives
        </h2>
        <p class="text-lg text-neutral-600 mb-8">
          Click below to personalize your message, then contact your reps
        </p>
      </div>

      <!-- Inline Confirmation (hidden until action taken) -->
      <InlineConfirmation />

      <!-- Representatives will be inserted here -->
      <div id="reps-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8"></div>
    </div>
  </section>

  <!-- State Impact Data (Full-width Green Section) -->
  <section id="state-impact-section" class="py-12 bg-gradient-to-br from-[var(--color-hemp-green)] to-[var(--color-soil-dark)] hidden">
    <div class="container mx-auto px-6 max-w-4xl">
      <div class="text-center mb-8">
        <h2 id="state-impact-title" class="text-3xl md:text-4xl font-bold text-white mb-4">
          Impact in Your State
        </h2>
        <div id="state-banned-warning" class="hidden bg-red-100 border-2 border-red-600 text-red-800 px-6 py-4 rounded-lg mb-6 text-lg font-bold">
          ‚ö†Ô∏è WARNING: Hemp products already banned in your state!
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <!-- Jobs at Risk -->
        <div class="bg-white/95 rounded-lg p-6 text-center">
          <div class="text-2xl md:text-3xl font-bold mb-3 text-neutral-800">
            Jobs at Risk
          </div>
          <div class="text-4xl md:text-5xl font-bold" style="color: var(--color-hemp-green);" id="state-jobs">
            Loading...
          </div>
        </div>

        <!-- Revenue -->
        <div class="bg-white/95 rounded-lg p-6 text-center">
          <div class="text-2xl md:text-3xl font-bold mb-3 text-neutral-800">
            Annual Revenue
          </div>
          <div class="text-4xl md:text-5xl font-bold" style="color: var(--color-hemp-green);" id="state-revenue">
            Loading...
          </div>
        </div>

        <!-- Businesses -->
        <div class="bg-white/95 rounded-lg p-6 text-center">
          <div class="text-xl md:text-2xl font-bold mb-3 text-neutral-800">
            Hemp Businesses
          </div>
          <div class="text-3xl md:text-4xl font-bold" style="color: var(--color-hemp-green);" id="state-businesses">
            Loading...
          </div>
        </div>
      </div>

      <div id="state-notes" class="mt-6 text-white/90 text-center italic"></div>
    </div>
  </section>

  <!-- Social Sharing Section (Back in reps section) -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-6 max-w-7xl">
      <!-- Social Sharing Section -->
      <div class="mt-16 text-center">
        <div class="card" style="background: white; border: 2px solid var(--color-hemp-green);">
          <h3 class="text-2xl md:text-3xl font-bold mb-4" style="color: var(--color-soil-dark);">
            Spread the Word
          </h3>
          <p class="text-lg text-neutral-600 mb-8">
            Share this campaign and help save the hemp industry
          </p>

          <div class="flex justify-center gap-4 flex-wrap">
            <button
              id="share-twitter"
              class="share-icon-btn"
              aria-label="Share on Twitter"
              title="Share on Twitter/X"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </button>
            <button
              id="share-bluesky"
              class="share-icon-btn"
              aria-label="Share on Bluesky"
              title="Share on Bluesky"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"/>
              </svg>
            </button>
            <button
              id="share-facebook"
              class="share-icon-btn"
              aria-label="Share on Facebook"
              title="Share on Facebook"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </button>
            <button
              id="share-linkedin"
              class="share-icon-btn"
              aria-label="Share on LinkedIn"
              title="Share on LinkedIn"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </button>
            <button
              id="copy-link"
              class="share-icon-btn"
              aria-label="Copy link"
              title="Copy link to clipboard"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
            </button>
          </div>

          <div id="link-copied" class="hidden mt-6 font-semibold" style="color: var(--color-hemp-green);">
            ‚úì Link copied to clipboard!
          </div>
        </div>
      </div>
    </div>
  </section>

  <style>
    .share-icon-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-hemp-green);
      background-color: white;
      color: var(--color-hemp-green);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .share-icon-btn:hover {
      background-color: var(--color-hemp-green);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 103, 65, 0.3);
    }

    .share-icon-btn:active {
      transform: translateY(0);
    }

    @media (max-width: 640px) {
      .share-icon-btn {
        width: 48px;
        height: 48px;
      }
    }

    /* Social media icons in representative cards */
    .social-icon-link {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-hemp-green);
      background-color: white;
      color: var(--color-hemp-green);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .social-icon-link:hover {
      background-color: var(--color-hemp-green);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 103, 65, 0.2);
    }

    .social-icon-link:active {
      transform: translateY(0);
    }
  </style>

  <!-- Representative Card Template -->
  <template id="rep-card-template">
    <div class="card rep-card">
      <!-- Name and Title -->
      <div class="mb-4">
        <h3 class="text-2xl font-bold mb-2 rep-name" style="color: var(--color-soil-dark);"></h3>
        <div class="flex flex-wrap gap-3 items-center text-neutral-600">
          <span class="rep-role font-semibold"></span>
          <span class="text-neutral-400">‚Ä¢</span>
          <span class="rep-party"></span>
        </div>
      </div>

      <!-- Contact Info -->
      <div class="mb-6 space-y-2">
        <div class="rep-phone flex items-center gap-2 text-neutral-700">
          <span class="text-xl">üìû</span>
          <a href="" class="phone-link hover:text-[var(--color-hemp-green)] transition-colors"></a>
        </div>
        <div class="rep-office text-neutral-600"></div>
      </div>

      <!-- Social Media Links -->
      <div class="rep-social flex gap-3 mb-6"></div>

      <!-- Action Buttons (Stacked) -->
      <div class="flex flex-col gap-3">
        <button class="btn-email btn-primary w-full">
          Contact Form
        </button>
        <button class="btn-call w-full px-6 py-3 rounded-lg font-semibold transition-all hover:transform hover:-translate-y-0.5 hover:shadow-lg border-2" style="border-color: var(--color-hemp-green); color: var(--color-hemp-green); background-color: transparent;">
          Call Now
        </button>
      </div>
    </div>
  </template>

  <!-- Scripts -->
  <script is:inline define:vars={{ apiKey: import.meta.env.PUBLIC_GOOGLE_CIVIC_API_KEY }}>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const zipFromUrl = urlParams.get('zip');

    // Elements
    const zipForm = document.getElementById('zip-form');
    const zipInput = document.getElementById('zip-input');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    const stateImpactSection = document.getElementById('state-impact-section');
    const messageTemplateSection = document.getElementById('message-template-section');
    const repsSection = document.getElementById('reps-section');
    const repsContainer = document.getElementById('reps-container');
    const repCardTemplate = document.getElementById('rep-card-template');

    // Store current state data globally for template generation
    let currentStateData = null;
    let currentStateName = '';

    // Debug logging
    console.log('Zip from URL:', zipFromUrl);

    // If zip code in URL, auto-fetch representatives
    if (zipFromUrl && zipFromUrl.match(/^\d{5}$/)) {
      zipInput.value = zipFromUrl;
      fetchRepresentatives(zipFromUrl);
    }

    // Form submit handler
    zipForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const zip = zipInput.value.trim();
      if (zip && zip.match(/^\d{5}$/)) {
        fetchRepresentatives(zip);
        // Update URL without reload
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('zip', zip);
        window.history.pushState({}, '', newUrl);
      }
    });

    /**
     * Fetch representatives directly from Google Civic API (client-side)
     */
    async function fetchRepresentatives(zip) {
      // Hide the zip form and instructions
      const zipFormContainer = document.getElementById('zip-form-container');
      const howToSection = document.getElementById('how-to-section');

      // Show loading state
      loadingState?.classList.remove('hidden');
      errorState?.classList.add('hidden');
      stateImpactSection?.classList.add('hidden');
      messageTemplateSection?.classList.add('hidden');
      repsSection?.classList.add('hidden');

      try {
        // Call our server-side API endpoint (using dynamic route params instead of query strings)
        const apiUrl = `/api/representatives-v2/${encodeURIComponent(zip)}/`;

        console.log('Fetching from:', apiUrl);

        const response = await fetch(apiUrl);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API returned ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('API response:', data);

        // Get representatives from response
        const representatives = data.representatives;
        const stateData = data.stateData;
        const stateName = data.state;

        if (!representatives || representatives.length === 0) {
          throw new Error('No representatives found for this zip code. Please try a different zip code.');
        }

        // Store state data for template generation
        currentStateData = stateData;
        currentStateName = stateName;

        // Display state impact data
        if (stateData) {
          displayStateData(stateData, stateName);
        }

        // Display representatives
        displayRepresentatives(representatives);

        // Initialize message template
        initializeMessageTemplate();

        // Hide loading and zip form/instructions, show results
        loadingState?.classList.add('hidden');
        zipFormContainer?.classList.add('hidden');
        howToSection?.classList.add('hidden');

        if (stateData) {
          stateImpactSection?.classList.remove('hidden');
        }
        messageTemplateSection?.classList.remove('hidden');
        repsSection?.classList.remove('hidden');

      } catch (error) {
        console.error('Error fetching representatives:', error);

        // Show error state
        loadingState?.classList.add('hidden');
        errorState?.classList.remove('hidden');

        if (errorMessage) {
          errorMessage.textContent = error instanceof Error
            ? error.message
            : 'Could not load representatives. Please try again.';
        }
      }
    }

    /**
     * Display state-specific impact data
     */
    function displayStateData(stateData, stateName) {
      const impactTitle = document.getElementById('state-impact-title');
      const jobsEl = document.getElementById('state-jobs');
      const revenueEl = document.getElementById('state-revenue');
      const businessesEl = document.getElementById('state-businesses');
      const notesEl = document.getElementById('state-notes');
      const bannedWarning = document.getElementById('state-banned-warning');

      if (impactTitle) {
        impactTitle.textContent = `Estimated Hemp Industry Impact in ${stateData.state_name}`;
      }

      // Format and display jobs - remove "estimated" prefix
      if (jobsEl) {
        let jobs = stateData.jobs_at_risk || stateData.jobs_current;
        if (typeof jobs === 'number') {
          jobsEl.textContent = jobs.toLocaleString();
        } else if (jobs) {
          // Remove "estimated" prefix if present
          const jobsStr = String(jobs).replace(/^estimated\s+/i, '');
          jobsEl.textContent = jobsStr;
        } else {
          jobsEl.textContent = 'N/A';
        }
      }

      // Display revenue with $ prefix and remove "estimated"
      if (revenueEl) {
        let revenue = stateData.revenue_annual || 'N/A';
        if (revenue !== 'N/A') {
          // Remove "estimated" prefix if present
          revenue = revenue.replace(/^estimated\s+/i, '');
          revenueEl.textContent = '$' + revenue;
        } else {
          revenueEl.textContent = revenue;
        }
      }

      // Display businesses
      if (businessesEl) {
        businessesEl.textContent = stateData.hemp_businesses || 'N/A';
      }

      // Display notes if available
      if (notesEl && stateData.notes) {
        notesEl.textContent = stateData.notes;
      }

      // Show banned warning if applicable
      if (bannedWarning && stateData.ban_status) {
        bannedWarning.classList.remove('hidden');
      }
    }

    /**
     * Display representatives in cards
     */
    function displayRepresentatives(representatives) {
      if (!repsContainer || !repCardTemplate) return;

      // Clear container
      repsContainer.innerHTML = '';

      // Create cards for each representative
      for (const rep of representatives) {
        console.log('Creating card for representative:', {
          name: rep.name,
          phone: rep.phone,
          contactForm: rep.contactForm,
          role: rep.role
        });

        const card = repCardTemplate.content.cloneNode(true);

        // Photo
        const photo = card.querySelector('.rep-photo');
        if (photo) {
          if (rep.photoUrl) {
            photo.src = rep.photoUrl;
            photo.alt = `Photo of ${rep.name}`;
          } else {
            // Default placeholder
            photo.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(rep.name)}&size=256&background=4a6741&color=fff&bold=true`;
            photo.alt = `${rep.name}`;
          }
        }

        // Name, role, party
        const nameEl = card.querySelector('.rep-name');
        const roleEl = card.querySelector('.rep-role');
        const partyEl = card.querySelector('.rep-party');

        if (nameEl) nameEl.textContent = rep.name;
        if (roleEl) roleEl.textContent = rep.role;
        if (partyEl) partyEl.textContent = rep.party;

        // Phone
        const phoneDiv = card.querySelector('.rep-phone');
        const phoneLink = card.querySelector('.phone-link');

        if (rep.phone && phoneDiv && phoneLink) {
          phoneLink.href = `tel:${rep.phone}`;
          phoneLink.textContent = rep.phone;
        } else if (phoneDiv) {
          phoneDiv.style.display = 'none';
        }

        // Office
        const officeEl = card.querySelector('.rep-office');
        if (officeEl) {
          officeEl.textContent = rep.office;
        }

        // Social Media
        const socialContainer = card.querySelector('.rep-social');
        if (socialContainer && rep.social) {
          const socialLinks = [];

          // Twitter/X
          if (rep.social.twitter) {
            socialLinks.push(`
              <a href="https://twitter.com/${rep.social.twitter}" target="_blank" rel="noopener noreferrer"
                 class="social-icon-link" aria-label="Follow on Twitter/X" title="Follow on Twitter/X">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
            `);
          }

          // Facebook
          if (rep.social.facebook) {
            socialLinks.push(`
              <a href="https://facebook.com/${rep.social.facebook}" target="_blank" rel="noopener noreferrer"
                 class="social-icon-link" aria-label="Follow on Facebook" title="Follow on Facebook">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
              </a>
            `);
          }

          // Instagram
          if (rep.social.instagram) {
            socialLinks.push(`
              <a href="https://instagram.com/${rep.social.instagram}" target="_blank" rel="noopener noreferrer"
                 class="social-icon-link" aria-label="Follow on Instagram" title="Follow on Instagram">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
              </a>
            `);
          }

          // YouTube
          if (rep.social.youtube) {
            socialLinks.push(`
              <a href="https://youtube.com/${rep.social.youtube}" target="_blank" rel="noopener noreferrer"
                 class="social-icon-link" aria-label="Follow on YouTube" title="Follow on YouTube">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
              </a>
            `);
          }

          if (socialLinks.length > 0) {
            socialContainer.innerHTML = socialLinks.join('');
          } else {
            socialContainer.style.display = 'none';
          }
        } else if (socialContainer) {
          socialContainer.style.display = 'none';
        }

        // Email button
        const emailBtn = card.querySelector('.btn-email');
        if (emailBtn) {
          emailBtn.addEventListener('click', () => {
            handleEmailAction(rep);
            // Show inline confirmation after a short delay (user has time to interact with contact form)
            setTimeout(() => {
              if (window.showInlineConfirmation) {
                window.showInlineConfirmation('email', zipInput.value, currentStateName);
              }
            }, 2000); // 2 second delay
          });
        }

        // Call button
        const callBtn = card.querySelector('.btn-call');
        if (callBtn) {
          if (rep.phone) {
            callBtn.addEventListener('click', () => {
              console.log('Calling:', rep.name, 'at', rep.phone);
              window.location.href = `tel:${rep.phone}`;
              // Show inline confirmation after a short delay (user has time to make the call)
              setTimeout(() => {
                if (window.showInlineConfirmation) {
                  window.showInlineConfirmation('call', zipInput.value, currentStateName);
                }
              }, 2000); // 2 second delay
            });
          } else {
            callBtn.disabled = true;
            callBtn.style.opacity = '0.5';
            callBtn.style.cursor = 'not-allowed';
            console.log('No phone number for:', rep.name);
          }
        }

        repsContainer.appendChild(card);
      }
    }

    /**
     * Handle email/contact form action
     * Opens the representative's contact form in a new tab
     */
    function handleEmailAction(rep) {
      console.log('Opening contact form for:', rep.name);
      console.log('Contact form URL:', rep.contactForm);

      if (rep.contactForm) {
        // Ensure URL has protocol
        let url = rep.contactForm;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        console.log('Opening URL:', url);
        window.open(url, '_blank');
      } else {
        // Fallback: show message if no contact form available
        alert(`Contact form not available for ${rep.name}. Please try calling instead: ${rep.phone || 'No phone number available'}`);
      }
    }

    /**
     * Initialize message template system
     */
    function initializeMessageTemplate() {
      const roleButtons = document.querySelectorAll('.role-btn');
      const messageContent = document.getElementById('message-content');
      const messageCard = document.getElementById('message-card');
      const copyBtn = document.getElementById('copy-message-btn');
      const copySuccess = document.getElementById('copy-success');

      let currentRole = null;

      // Don't generate initial message - wait for user to select a role

      // Role button handlers
      roleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Show message card on first click
          if (messageCard && messageCard.classList.contains('hidden')) {
            messageCard.classList.remove('hidden');
          }

          // Update active state
          roleButtons.forEach(b => {
            b.classList.remove('active');
            b.style.backgroundColor = 'white';
            b.style.color = 'var(--color-hemp-green)';
          });
          btn.classList.add('active');
          btn.style.backgroundColor = 'var(--color-hemp-green)';
          btn.style.color = 'white';

          // Update message
          currentRole = btn.dataset.role;
          updateMessage(currentRole);
        });
      });

      // Copy button handler
      if (copyBtn && messageContent) {
        copyBtn.addEventListener('click', async () => {
          const message = messageContent.textContent;
          try {
            await navigator.clipboard.writeText(message);
            if (copySuccess) {
              copySuccess.classList.remove('hidden');
              setTimeout(() => {
                copySuccess.classList.add('hidden');
              }, 3000);
            }
          } catch (err) {
            console.error('Failed to copy:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = message;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            if (copySuccess) {
              copySuccess.classList.remove('hidden');
              setTimeout(() => {
                copySuccess.classList.add('hidden');
              }, 3000);
            }
          }
        });
      }

      function updateMessage(role) {
        if (!messageContent || !currentStateData) return;

        // Get state stats
        const stateName = currentStateData.state_name || currentStateName;
        let jobs = currentStateData.jobs_at_risk || currentStateData.jobs_current || 'thousands';
        if (typeof jobs === 'number') {
          jobs = jobs.toLocaleString();
        } else if (typeof jobs === 'string') {
          jobs = jobs.replace(/^estimated\s+/i, '');
        }

        let revenue = currentStateData.revenue_annual || 'millions';
        if (revenue !== 'N/A' && revenue !== 'millions') {
          revenue = revenue.replace(/^estimated\s+/i, '');
        }

        const businesses = currentStateData.hemp_businesses || 'many';

        // Generate message based on role
        let message = '';

        if (role === 'consumer') {
          message = `Dear Representative,

I am writing to you as a constituent and consumer of hemp products to express my urgent concern about the Farm Bill's restrictions on hemp-derived products.

IN ${stateName.toUpperCase()}, THIS BAN WILL IMPACT:
‚Ä¢ ${jobs} jobs at risk
‚Ä¢ $${revenue} in annual revenue threatened
‚Ä¢ ${businesses} hemp businesses facing closure

I support reasonable regulation of hemp products, but this ban KILLS the industry rather than protecting consumers. The Farm Bill's restrictions on "total THC" (including Delta-8, Delta-10, THCa) and the 0.4mg per package limit will eliminate products that millions of Americans rely on for wellness, including gummies, vapes, drinks, and topicals.

This ban:
‚Ä¢ Takes effect November 12, 2026 (bill signed November 12, 2025)
‚Ä¢ Overrides state laws that have already regulated hemp successfully
‚Ä¢ Eliminates jobs and businesses without addressing real safety concerns

I urge you to support REGULATION, not PROHIBITION. Work with the industry to create sensible standards that protect consumers while preserving this legal, growing sector of our economy.

Please vote to amend the Farm Bill to allow states to regulate hemp products as they see fit, or support legislation that establishes federal standards without eliminating the entire industry.

Thank you for your time and consideration.`;
        } else if (role === 'farmer') {
          message = `Dear Representative,

I am writing to you as a hemp farmer in ${stateName} to express my urgent concern about the Farm Bill's devastating impact on hemp agriculture.

IN ${stateName.toUpperCase()}, THIS BAN WILL IMPACT:
‚Ä¢ ${jobs} agricultural and industry jobs at risk
‚Ä¢ $${revenue} in annual revenue from hemp farming and processing
‚Ä¢ ${businesses} hemp businesses that depend on our crops

The Farm Bill's restrictions on hemp-derived products will destroy the market for hemp crops overnight. As a farmer, I have invested in equipment, land, and expertise to grow legal hemp under the 2018 Farm Bill. This new ban eliminates the downstream market for our crops.

This ban:
‚Ä¢ Takes effect November 12, 2026 (bill signed November 12, 2025)
‚Ä¢ Defines "total THC" to include Delta-8, Delta-10, THCa, making most hemp crops non-compliant
‚Ä¢ Sets a 0.4mg per package limit that eliminates all viable hemp product markets
‚Ä¢ Bans gummies, vapes, drinks, and topicals - the primary markets for hemp farmers

I support reasonable regulation, but this ban KILLS our farms and our livelihoods. Hemp farmers have operated legally and invested millions based on the 2018 Farm Bill framework. This sudden prohibition betrays that trust.

Please vote to amend the Farm Bill to protect hemp farmers and allow states to regulate hemp products. We need REGULATION, not PROHIBITION.

Thank you for supporting American agriculture.`;
        } else if (role === 'industry') {
          message = `Dear Representative,

I am writing to you as an employee in the hemp industry in ${stateName} to express my urgent concern about the Farm Bill's impact on my job and livelihood.

IN ${stateName.toUpperCase()}, THIS BAN WILL IMPACT:
‚Ä¢ ${jobs} jobs like mine at immediate risk
‚Ä¢ $${revenue} in annual economic activity
‚Ä¢ ${businesses} hemp businesses facing closure

I work in a legal, regulated industry that provides good jobs and quality products to millions of Americans. The Farm Bill's restrictions will eliminate my job and destroy an entire sector of our economy.

This ban:
‚Ä¢ Takes effect November 12, 2026 (bill signed November 12, 2025)
‚Ä¢ Eliminates products through "total THC" restrictions and 0.4mg limits
‚Ä¢ Bans gummies, vapes, drinks, and topicals that our customers rely on
‚Ä¢ Overrides state regulations that were already working

Our industry supports REGULATION - we want quality standards, testing requirements, and consumer protections. But this ban KILLS our jobs instead of creating a safer marketplace.

This is not about opposing regulation. This is about preserving legal businesses, protecting jobs, and respecting states' rights to regulate hemp as they see fit.

Please vote to amend the Farm Bill to support regulation rather than prohibition. Allow states to create their own hemp standards, or work with industry to develop federal standards that protect consumers without eliminating an entire legal market.

My job, my colleagues' jobs, and thousands of jobs across ${stateName} depend on your action.

Thank you for your consideration.`;
        }

        messageContent.textContent = message;
      }
    }

    /**
     * Initialize social sharing
     */
    document.addEventListener('DOMContentLoaded', () => {
      const shareTwitter = document.getElementById('share-twitter');
      const shareBluesky = document.getElementById('share-bluesky');
      const shareFacebook = document.getElementById('share-facebook');
      const shareLinkedIn = document.getElementById('share-linkedin');
      const copyLink = document.getElementById('copy-link');
      const linkCopied = document.getElementById('link-copied');

      const siteUrl = 'https://standforhemp.com';
      const shareText = 'I just contacted my representatives to save the hemp industry. 300,000 jobs and $28B at risk. Join me at StandforHemp.com #SaveHemp';

      if (shareTwitter) {
        shareTwitter.addEventListener('click', () => {
          const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(siteUrl)}`;
          window.open(twitterUrl, '_blank', 'width=550,height=420');
        });
      }

      if (shareBluesky) {
        shareBluesky.addEventListener('click', () => {
          const blueskyUrl = `https://bsky.app/intent/compose?text=${encodeURIComponent(shareText + ' ' + siteUrl)}`;
          window.open(blueskyUrl, '_blank', 'width=550,height=420');
        });
      }

      if (shareFacebook) {
        shareFacebook.addEventListener('click', () => {
          const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(siteUrl)}&quote=${encodeURIComponent(shareText)}`;
          window.open(facebookUrl, '_blank', 'width=550,height=420');
        });
      }

      if (shareLinkedIn) {
        shareLinkedIn.addEventListener('click', () => {
          const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(siteUrl)}`;
          window.open(linkedInUrl, '_blank', 'width=550,height=420');
        });
      }

      if (copyLink && linkCopied) {
        copyLink.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(siteUrl);
            linkCopied.classList.remove('hidden');
            setTimeout(() => {
              linkCopied.classList.add('hidden');
            }, 3000);
          } catch (err) {
            console.error('Failed to copy:', err);
            // Fallback
            const textArea = document.createElement('textarea');
            textArea.value = siteUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            linkCopied.classList.remove('hidden');
            setTimeout(() => {
              linkCopied.classList.add('hidden');
            }, 3000);
          }
        });
      }
    });
  </script>
</LandingLayout>
