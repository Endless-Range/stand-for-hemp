---
/**
 * US Map with actual SVG state shapes
 * Color-coded by hemp industry impact
 */

import { getStateData, getImpactLevel, getImpactColor, formatJobs, formatRevenue } from '../../utils/stateData';

// Build state data for client-side access
const stateDataMap: Record<string, any> = {};
const stateAbbrs = [
  'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
  'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
  'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
  'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
  'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
];

for (const abbr of stateAbbrs) {
  const data = getStateData(abbr);
  if (data) {
    const level = getImpactLevel(data);
    stateDataMap[abbr] = {
      name: data.state_name,
      jobs: formatJobs(data.jobs_at_risk || data.jobs_current),
      revenue: formatRevenue(data.revenue_annual),
      businesses: data.hemp_businesses || 'N/A',
      color: getImpactColor(level),
      level: level,
      banned: !!data.ban_status,
      notes: data.notes || ''
    };
  }
}
---

<div class="us-map-svg-container">
  <!-- Header -->
  <div class="text-center mb-8">
    <h3 class="text-2xl md:text-3xl font-bold mb-4" style="color: var(--color-soil-dark);">
      Hemp Industry Impact Across America
    </h3>
    <p class="text-lg text-neutral-600 mb-6">
      Click any state to see detailed economic impact
    </p>

    <!-- Legend -->
    <div class="flex flex-wrap justify-center gap-3 md:gap-6 text-xs md:text-sm mb-8">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #dc2626;"></div>
        <span class="whitespace-nowrap">Critical (10,000+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #ea580c;"></div>
        <span class="whitespace-nowrap">High (2,000+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #ca8a04;"></div>
        <span class="whitespace-nowrap">Medium (500+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #65a30d;"></div>
        <span class="whitespace-nowrap">Lower Impact</span>
      </div>
    </div>
  </div>

  <!-- Info Display Card -->
  <div id="map-state-card" class="map-state-card hidden">
    <button id="close-map-card" class="close-btn" aria-label="Close">✕</button>
    <div id="map-card-banned" class="banned-badge hidden">⚠️ ALREADY BANNED</div>
    <h4 id="map-card-state" class="font-bold text-2xl mb-4" style="color: var(--color-soil-dark);"></h4>
    <div class="space-y-3">
      <div class="info-row">
        <span class="info-label">Jobs at Risk:</span>
        <span id="map-card-jobs" class="info-value"></span>
      </div>
      <div class="info-row">
        <span class="info-label">Annual Revenue:</span>
        <span id="map-card-revenue" class="info-value"></span>
      </div>
      <div class="info-row">
        <span class="info-label">Hemp Businesses:</span>
        <span id="map-card-businesses" class="info-value"></span>
      </div>
    </div>
    <div id="map-card-notes" class="mt-4 text-sm text-neutral-600 italic"></div>
  </div>

  <!-- SVG Map Container -->
  <div class="svg-map-wrapper">
    <p class="text-center text-neutral-600 mb-4">
      Interactive US map visualization
    </p>

    <!-- Placeholder for now - you can add actual SVG map paths here -->
    <div class="map-placeholder">
      <p class="text-neutral-500 text-center">
        For a production map, you can use a library like:
        <br><br>
        • <strong>amCharts</strong> (free for non-commercial use)
        <br>
        • <strong>DataMaps</strong> (open source)
        <br>
        • <strong>react-simple-maps</strong> (if using React)
        <br><br>
        Or embed from <strong>Google Charts</strong> or <strong>Mapbox</strong>
      </p>
    </div>
  </div>

  <!-- Fallback: Show grid instead -->
  <div class="text-center mt-8">
    <p class="text-neutral-600 mb-4">
      Meanwhile, use our state grid for easy browsing:
    </p>
    <a href="#state-grid" class="inline-block px-6 py-3 rounded-lg font-semibold bg-[var(--color-hemp-green)] text-white hover:bg-[var(--color-soil-dark)] transition-colors">
      View State Grid Below ↓
    </a>
  </div>
</div>

<style>
  .us-map-svg-container {
    position: relative;
    padding: 1rem 0;
  }

  .svg-map-wrapper {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .map-placeholder {
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 3rem 2rem;
  }

  .map-state-card {
    background: white;
    border: 3px solid var(--color-hemp-green);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem auto;
    max-width: 600px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    position: relative;
  }

  .map-state-card.hidden {
    display: none;
  }

  .close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }

  .close-btn:hover {
    background: #f0f0f0;
    color: #000;
  }

  .banned-badge {
    background: #fee2e2;
    color: #dc2626;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: bold;
    margin-bottom: 1rem;
    display: inline-block;
  }

  .banned-badge.hidden {
    display: none;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .info-label {
    font-weight: 600;
    color: var(--color-soil-dark);
  }

  .info-value {
    font-weight: 700;
    color: var(--color-hemp-green);
    text-align: right;
  }

  @media (max-width: 768px) {
    .map-state-card {
      margin: 1rem;
      padding: 1.5rem;
    }
  }
</style>

<script is:inline define:vars={{ stateDataMap }}>
  // Close button handler
  document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.getElementById('close-map-card');
    const card = document.getElementById('map-state-card');

    if (closeBtn && card) {
      closeBtn.addEventListener('click', () => {
        card.classList.add('hidden');
      });
    }
  });
</script>
