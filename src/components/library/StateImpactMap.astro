---
/**
 * Interactive US State Map showing hemp industry impact by state
 * Color-coded by impact level with hover tooltips
 */

import { getStateData, getImpactLevel, getImpactColor, formatJobs, formatRevenue } from '../../utils/stateData';

// Build state data for client-side access
const stateDataMap: Record<string, any> = {};
const stateAbbrs = [
  'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
  'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
  'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
  'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
  'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
];

for (const abbr of stateAbbrs) {
  const data = getStateData(abbr);
  if (data) {
    const level = getImpactLevel(data);
    stateDataMap[abbr] = {
      name: data.state_name,
      jobs: formatJobs(data.jobs_at_risk || data.jobs_current),
      revenue: formatRevenue(data.revenue_annual),
      businesses: data.hemp_businesses || 'N/A',
      color: getImpactColor(level),
      level: level,
      banned: !!data.ban_status,
      notes: data.notes || ''
    };
  }
}
---

<div class="state-impact-map-container">
  <div class="map-header text-center mb-8">
    <h3 class="text-2xl md:text-3xl font-bold mb-4" style="color: var(--color-soil-dark);">
      Impact by State
    </h3>
    <p class="text-lg text-neutral-600 mb-6">
      Hover over any state to see the economic impact
    </p>

    <!-- Legend -->
    <div class="flex flex-wrap justify-center gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #dc2626;"></div>
        <span>Critical (10,000+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #ea580c;"></div>
        <span>High (2,000+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #ca8a04;"></div>
        <span>Medium (500+ jobs)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded" style="background-color: #65a30d;"></div>
        <span>Lower impact</span>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="map-tooltip" class="map-tooltip hidden">
    <div class="tooltip-content">
      <h4 id="tooltip-state" class="font-bold text-lg mb-2"></h4>
      <div id="tooltip-banned" class="text-red-600 font-bold mb-2 hidden">⚠️ ALREADY BANNED</div>
      <div class="space-y-1 text-sm">
        <p><strong>Jobs at Risk:</strong> <span id="tooltip-jobs"></span></p>
        <p><strong>Annual Revenue:</strong> <span id="tooltip-revenue"></span></p>
        <p><strong>Businesses:</strong> <span id="tooltip-businesses"></span></p>
      </div>
    </div>
  </div>

  <!-- SVG Map -->
  <div class="map-wrapper">
    <svg id="us-map" viewBox="0 0 960 600" xmlns="http://www.w3.org/2000/svg">
      <!-- States will be rendered here with paths -->
      <!-- Using simplified US map coordinates -->
      <g id="states">
        <!-- I'll add a simplified version - in production you'd use a proper US map SVG -->
        <!-- For now, creating clickable state rectangles in approximate positions -->
      </g>
    </svg>
  </div>
</div>

<style>
  .state-impact-map-container {
    position: relative;
    padding: 2rem 0;
  }

  .map-wrapper {
    max-width: 900px;
    margin: 0 auto;
    position: relative;
  }

  #us-map {
    width: 100%;
    height: auto;
  }

  .state-path {
    stroke: #fff;
    stroke-width: 1.5;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .state-path:hover {
    opacity: 0.8;
    stroke-width: 2.5;
    filter: brightness(1.1);
  }

  .map-tooltip {
    position: fixed;
    background: white;
    border: 2px solid var(--color-hemp-green);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    z-index: 1000;
    max-width: 300px;
  }

  .map-tooltip.hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .map-tooltip {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      max-width: none;
    }
  }
</style>

<script define:vars={{ stateDataMap }}>
  // We'll use a simplified approach with a US map library
  // For now, let's create a simple grid-based visualization

  const statesGroup = document.getElementById('states');
  const tooltip = document.getElementById('map-tooltip');

  if (statesGroup && tooltip) {
    // Simple state positioning (we'll improve this with actual SVG paths)
    const statePositions = {
      'WA': [50, 50], 'OR': [50, 100], 'CA': [40, 150],
      'ID': [100, 80], 'NV': [80, 130], 'UT': [120, 130],
      'AZ': [100, 180], 'MT': [150, 50], 'WY': [150, 100],
      'CO': [160, 150], 'NM': [150, 200], 'TX': [200, 250],
      'OK': [240, 220], 'KS': [240, 180], 'NE': [240, 140],
      'SD': [260, 100], 'ND': [260, 60], 'MN': [300, 80],
      'IA': [310, 140], 'MO': [310, 180], 'AR': [310, 220],
      'LA': [320, 260], 'WI': [340, 100], 'IL': [350, 160],
      'MS': [350, 240], 'AL': [370, 240], 'TN': [370, 210],
      'KY': [380, 190], 'IN': [370, 170], 'MI': [380, 120],
      'OH': [400, 170], 'WV': [420, 190], 'VA': [450, 200],
      'NC': [470, 220], 'SC': [460, 240], 'GA': [430, 250],
      'FL': [450, 290], 'PA': [440, 170], 'NY': [460, 140],
      'VT': [480, 110], 'NH': [490, 120], 'ME': [510, 90],
      'MA': [500, 140], 'RI': [505, 145], 'CT': [495, 150],
      'NJ': [475, 165], 'DE': [470, 180], 'MD': [460, 185],
      'HI': [200, 400], 'AK': [50, 400]
    };

    Object.entries(stateDataMap).forEach(([abbr, data]) => {
      const pos = statePositions[abbr];
      if (!pos) return;

      // Create a circle for each state (simplified visualization)
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', pos[0].toString());
      circle.setAttribute('cy', pos[1].toString());
      circle.setAttribute('r', '12');
      circle.setAttribute('fill', data.color);
      circle.classList.add('state-path');
      circle.dataset.state = abbr;

      // Add state abbreviation text
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pos[0].toString());
      text.setAttribute('y', (pos[1] + 4).toString());
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('font-size', '8');
      text.setAttribute('font-weight', 'bold');
      text.setAttribute('fill', 'white');
      text.setAttribute('pointer-events', 'none');
      text.textContent = abbr;

      statesGroup.appendChild(circle);
      statesGroup.appendChild(text);

      // Hover events
      circle.addEventListener('mouseenter', (e) => showTooltip(e, abbr, data));
      circle.addEventListener('mousemove', (e) => moveTooltip(e));
      circle.addEventListener('mouseleave', hideTooltip);
    });
  }

  function showTooltip(e, abbr, data) {
    const tooltip = document.getElementById('map-tooltip');
    const tooltipState = document.getElementById('tooltip-state');
    const tooltipJobs = document.getElementById('tooltip-jobs');
    const tooltipRevenue = document.getElementById('tooltip-revenue');
    const tooltipBusinesses = document.getElementById('tooltip-businesses');
    const tooltipBanned = document.getElementById('tooltip-banned');

    if (tooltipState) tooltipState.textContent = data.name;
    if (tooltipJobs) tooltipJobs.textContent = data.jobs;
    if (tooltipRevenue) tooltipRevenue.textContent = data.revenue;
    if (tooltipBusinesses) tooltipBusinesses.textContent = data.businesses;

    if (tooltipBanned) {
      if (data.banned) {
        tooltipBanned.classList.remove('hidden');
      } else {
        tooltipBanned.classList.add('hidden');
      }
    }

    if (tooltip) {
      tooltip.classList.remove('hidden');
      moveTooltip(e);
    }
  }

  function moveTooltip(e) {
    const tooltip = document.getElementById('map-tooltip');
    if (!tooltip) return;

    // On mobile, keep tooltip at bottom
    if (window.innerWidth <= 768) return;

    const x = e.clientX;
    const y = e.clientY;

    tooltip.style.left = (x + 15) + 'px';
    tooltip.style.top = (y + 15) + 'px';
  }

  function hideTooltip() {
    const tooltip = document.getElementById('map-tooltip');
    if (tooltip) {
      tooltip.classList.add('hidden');
    }
  }
</script>
---

<parameter name="file_path">/Users/hilarytorn/01Git/stand-for-hemp/src/components/library/StateImpactMap.astro